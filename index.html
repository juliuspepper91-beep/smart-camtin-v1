<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>üì∏ Smart Camtin ‚Äî Enhanced Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<meta name="theme-color" content="#0078d7">

<!-- Tailwind CDN (optional ‚Äî you're using existing CSS but Tailwind is available if you want to add utilities) -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
:root {
  --primary: #0078d7;
  --primary-dark: #005fa3;
  --bg-dark: #111;
  --bg-light: #f7f7f7;
  --card-dark: rgba(255,255,255,0.05);
  --card-light: rgba(255,255,255,0.9);
  --text-light: #fff;
  --text-dark: #111;
}
*, *::before, *::after { box-sizing: border-box; transition: all 0.22s ease; }
body {
  font-family: "Poppins", sans-serif;
  margin: 0;
  background: linear-gradient(180deg, #151515, #2b2b2b);
  color: var(--text-light);
  min-height: 100vh;
  overflow-x: hidden;
}
body.light {
  background: linear-gradient(180deg, #fafafa, #e2e2e2);
  color: var(--text-dark);
}
nav {
  position: fixed;
  top: 0; left: 0; right: 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 24px;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(8px);
  z-index: 100;
}
body.light nav { background: rgba(255,255,255,0.9); }
nav h1 { margin:0; font-size:20px; display:flex; align-items:center; gap:8px; }
.nav-right { display:flex; align-items:center; gap:12px; }
.btn {
  padding: 8px 14px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 500;
  background: var(--primary);
  color: #fff;
  transition: 0.18s ease;
}
.btn:hover { background: var(--primary-dark); transform: translateY(-1px); }
.btn.secondary { background: transparent; border: 1px solid rgba(255,255,255,0.12); color: inherit; }
main {
  margin-top: 90px;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:24px 12px;
  gap:24px;
}
.card {
  background: var(--card-dark);
  padding: 24px;
  border-radius: 14px;
  box-shadow: 0 10px 20px rgba(0,0,0,0.6);
  max-width: 900px;
  width: 100%;
}
body.light .card {
  background: var(--card-light);
  box-shadow: 0 6px 15px rgba(0,0,0,0.1);
}
.auth-wrap { display:flex; gap:24px; flex-wrap:wrap; justify-content:center; }
.auth-box {
  background: rgba(255,255,255,0.03);
  padding:20px;
  border-radius:12px;
  min-width:280px;
  flex:1;
  max-width:360px;
}
body.light .auth-box { background: rgba(255,255,255,0.65); }
.auth-box h3 { margin-top:0; margin-bottom:12px; font-weight:600; }
label { display:block; font-size:13px; margin-top:10px; opacity:0.8; }
input { width:100%; padding:10px 12px; margin-top:4px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); background:transparent; color:inherit; }
body.light input { border-color:#ccc; color:#111; }
.small { font-size:13px; opacity:0.75; }
.profile-container { display:flex; align-items:center; gap:18px; margin-top:16px; }
.profile-container img { width:100px; height:100px; border-radius:50%; object-fit:cover; border:2px solid var(--primary); }
.activity-feed { margin-top:20px; max-height:200px; overflow-y:auto; border-top:1px solid rgba(255,255,255,0.12); padding-top:12px; }
.activity-item { padding:6px 0; border-bottom:1px solid rgba(255,255,255,0.05); font-size:14px; opacity:0.85; }
.chat-card { margin-top:20px; display:flex; flex-direction:column; max-height:520px; }
.messages { flex:1; overflow-y:auto; padding:10px; border:1px solid rgba(255,255,255,0.12); border-radius:10px; background:rgba(0,0,0,0.08); margin-bottom:6px; min-height:180px; }
.message { display:flex; align-items:flex-start; gap:8px; margin-bottom:10px; }
.message .meta { font-size:12px; opacity:0.7; margin-bottom:4px; display:flex; align-items:center; gap:6px; }
.message img { width:36px; height:36px; border-radius:50%; object-fit:cover; }
.message .content { background: rgba(0,0,0,0.18); padding:8px 12px; border-radius:10px; max-width:78%; word-wrap:break-word; position:relative; }
body.light .messages .message .content { background: rgba(255,255,255,0.6); }
.message-actions { display:flex; gap:6px; margin-left:4px; opacity:0; transition: opacity 0.15s ease; }
.message.own .content { border:1px solid rgba(0,120,215,0.5); }
.message:hover .message-actions { opacity:1; }
.message-action-btn { font-size:11px; padding:2px 6px; border-radius:999px; border:none; cursor:pointer; background:rgba(255,255,255,0.1); color:inherit; }
.message-action-btn:hover { background:rgba(255,255,255,0.22); }
.message-edited-tag { font-size:10px; opacity:0.6; margin-left:4px; }
input.chat-input { flex:1; padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.12); background:transparent; color:inherit; }
body.light input.chat-input { border-color:#ccc; color:#111; }
.chat-controls { display:flex; gap:8px; align-items:center; }
#typing-indicator { font-size:13px; margin-bottom:6px; opacity:0.8; min-height:18px; }
.footer-row { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-top:12px; }
#loader { position:fixed; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:606; background: var(--bg-dark); color: var(--text-light); z-index:999; }
.toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:var(--primary); color:#fff; padding:10px 20px; border-radius:10px; opacity:0; transition:0.5s ease; pointer-events:none; z-index:9999; }
.toast.show { opacity:1; pointer-events:auto; }
.password-toggle { position:absolute; right:10px; top:50%; transform:translateY(-50%); background:none; border:none; cursor:pointer; color:inherit; }
.skeleton { background: linear-gradient(-90deg, #ddd 0%, #eee 50%, #ddd 100%); background-size: 400% 400%; animation: shimmer 1.4s ease infinite; border-radius:8px; }
.online-user { cursor:pointer; display:inline-block; padding:4px 8px; margin-right:6px; margin-bottom:6px; border-radius:8px; background:rgba(255,255,255,0.04); }
.online-user:hover { transform:translateY(-2px); background:rgba(0,0,0,0.14); }
@keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
@media (max-width:820px) { .auth-wrap { flex-direction:column; gap:16px; } .profile-container { flex-direction:column; gap:12px; } nav h1 { font-size:18px; } .card { padding:16px; } }
/* =========================
   üéÑ Christmas Mood Styles
   ========================= */

/* Festive glow */
.christmas-glow {
  box-shadow: 0 0 18px rgba(255, 60, 60, 0.35),
              0 0 30px rgba(60, 200, 120, 0.25);
}

/* Christmas accent colors */
:root {
  --christmas-red: #c62828;
  --christmas-green: #2e7d32;
  --christmas-gold: #ffd54f;
}

/* Navbar festive border */
body.christmas nav {
  border-bottom: 2px solid var(--christmas-gold);
}

/* Christmas button pulse */
body.christmas .btn {
  background: linear-gradient(135deg, var(--christmas-red), var(--christmas-green));
}
body.christmas .btn:hover {
  filter: brightness(1.15);
}

/* Snow canvas */
#snow-canvas {
  position: fixed;
  top: 0;
  left: 0;
  pointer-events: none;
  z-index: 999;
}

/* Santa floating */
#santa {
  position: fixed;
  bottom: 20px;
  right: 20px;
  font-size: 40px;
  animation: santaFloat 4s ease-in-out infinite;
  z-index: 9999;
  cursor: pointer;
}

@keyframes santaFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-12px); }
}
/* =========================
   Auth Hero Design Section
   ========================= */
.auth-hero {
  display: flex;
  gap: 0;
  border-radius: 20px;
  overflow: hidden;
  margin-bottom: 24px;
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  min-height: 280px;
}

body.light .auth-hero {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
}

.auth-hero-image {
  flex: 0 0 45%;
  position: relative;
  overflow: hidden;
}

.auth-hero-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: center top;
  transition: transform 0.5s ease;
}

.auth-hero:hover .auth-hero-image img {
  transform: scale(1.05);
}

.auth-hero-image::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent 60%, rgba(26,26,46,0.9) 100%);
}

body.light .auth-hero-image::after {
  background: linear-gradient(90deg, transparent 60%, rgba(102,126,234,0.8) 100%);
}

.auth-hero-content {
  flex: 1;
  padding: 32px 28px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  position: relative;
}

.auth-hero-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(10px);
  padding: 6px 14px;
  border-radius: 50px;
  font-size: 12px;
  font-weight: 500;
  margin-bottom: 16px;
  width: fit-content;
  border: 1px solid rgba(255,255,255,0.2);
}

.auth-hero-badge .dot {
  width: 8px;
  height: 8px;
  background: #00ff88;
  border-radius: 50%;
  animation: pulse-dot 2s infinite;
}

@keyframes pulse-dot {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(1.2); }
}

.auth-hero-content h2 {
  margin: 0 0 12px 0;
  font-size: 28px;
  font-weight: 600;
  line-height: 1.3;
  background: linear-gradient(135deg, #fff 0%, #a8edea 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

body.light .auth-hero-content h2 {
  background: linear-gradient(135deg, #fff 0%, #ffecd2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.auth-hero-content p {
  margin: 0 0 20px 0;
  font-size: 14px;
  opacity: 0.9;
  line-height: 1.7;
  color: rgba(255,255,255,0.85);
}

.auth-hero-features {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.auth-hero-features span {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: rgba(255,255,255,0.1);
  padding: 8px 14px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: 500;
  border: 1px solid rgba(255,255,255,0.1);
  transition: all 0.3s ease;
}

.auth-hero-features span:hover {
  background: rgba(255,255,255,0.2);
  transform: translateY(-2px);
}

.auth-hero-features span .icon {
  font-size: 16px;
}

/* Decorative elements */
.auth-hero-content::before {
  content: '';
  position: absolute;
  top: -50px;
  right: -50px;
  width: 150px;
  height: 150px;
  background: radial-gradient(circle, rgba(0,120,215,0.3) 0%, transparent 70%);
  border-radius: 50%;
}

/* Mobile view */
@media (max-width: 700px) {
  .auth-hero {
    flex-direction: column;
    min-height: auto;
  }
  
  .auth-hero-image {
    flex: 0 0 200px;
    max-height: 200px;
  }
  
  .auth-hero-image::after {
    background: linear-gradient(180deg, transparent 50%, rgba(26,26,46,0.95) 100%);
  }
  
  body.light .auth-hero-image::after {
    background: linear-gradient(180deg, transparent 50%, rgba(102,126,234,0.9) 100%);
  }
  
  .auth-hero-content {
    padding: 24px 20px;
    text-align: center;
  }
  
  .auth-hero-content h2 {
    font-size: 22px;
  }
  
  .auth-hero-badge {
    margin-left: auto;
    margin-right: auto;
  }
  
  .auth-hero-features {
    justify-content: center;
  }
}

/* Legacy support */
.auth-image-design {
  display: none;
}

</style>
</head>
<body>
<div id="loader">üöÄ Loading Smart Camtin...</div>
<div id="toast" class="toast"></div>
<canvas id="snow-canvas"></canvas>
<div id="santa" title="Ho Ho Ho! üéÅ">üéÖ</div>

<nav>
  <h1>üì∏ Smart Camtin</h1>
  <div class="nav-right">
    <button id="mode-toggle" class="btn secondary" title="Toggle Light/Dark">üåô</button>
    <div id="user-area" style="display:none;align-items:center; gap:8px;">
      <div id="user-name" class="small">Hi, user</div>
      <button id="signout" class="btn">Sign out</button>
    </div>
    <div id="auth-buttons" style="display:none;">
      <button id="open-auth" class="btn">Sign In / Sign Up</button>
    </div>
  </div>
</nav>

<main>
  <!-- AUTH CARD -->
  <div id="auth-card" class="card">
    <!-- Beautiful Auth Hero Section -->
    <div class="auth-hero">
      <div class="auth-hero-image">
        <img 
          src="https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=600&h=800&fit=crop&crop=faces" 
          alt="Welcome to Smart Camtin"
        />
      </div>
      <div class="auth-hero-content">
        <div class="auth-hero-badge">
          <span class="dot"></span>
          <span>Join 10,000+ Users</span>
        </div>
        <h2>Welcome to Smart Camtin ‚ú®</h2>
        <p>
          Connect, chat, and share moments with friends in real-time. 
          Enjoy a cozy Christmas vibe while you talk, and experience a beautifully designed platform built for modern communication.
        </p>
        <div class="auth-hero-features">
          <span><span class="icon">üí¨</span> Real-time Chat</span>
          <span><span class="icon">üì∏</span> Share Photos</span>
          <span><span class="icon">üü¢</span> See Who's Online</span>
          <span><span class="icon">‚úèÔ∏è</span> Message Editing/Deletion</span>
          <span><span class="icon">üîí</span> Secure &amp; Private</span>
        </div>
      </div>
    </div>

    <!-- Season 1 Model: Ash Spotlight -->
    <div class="card" style="margin-top:16px; background: linear-gradient(135deg, rgba(15,52,96,0.9), rgba(118,75,162,0.9)); display:flex; flex-wrap:wrap; gap:18px; align-items:center; border-radius:18px; overflow:hidden;">
      <div style="flex:0 0 120px; display:flex; justify-content:center; padding:14px 0 14px 14px;">
        <img 
          src="https://images.unsplash.com/photo-1544723795-3fb6469f5b39?w=400&h=400&fit=crop&crop=faces" 
          alt="Season 1 Model Ash" 
          style="width:110px; height:110px; border-radius:18px; object-fit:cover; box-shadow:0 10px 25px rgba(0,0,0,0.35); border:2px solid rgba(255,255,255,0.7);" 
        />
      </div>
      <div style="flex:1; padding:14px 18px 14px 0; min-width:220px; color:#fff;">
        <div style="font-size:12px; opacity:0.85; letter-spacing:0.08em; text-transform:uppercase; margin-bottom:4px;">Season 1 Model</div>
        <h3 style="margin:0 0 6px 0; font-size:20px; font-weight:600;">Ash ‚Äî The Holiday Host</h3>
        <p style="margin:0 0 6px 0; font-size:13px; opacity:0.9; line-height:1.6;">
          Ash welcomes you to Smart Camtin Season 1. Share your stories, react with emojis, and
          connect with friends worldwide in a festive, cozy atmosphere.
        </p>
      </div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center; flex-wrap:wrap; margin-top:8px;">
      <div>
        <h2 style="margin:0 0 6px 0">Get Started</h2>
        <div class="small">Create an account or sign in to access your dashboard.</div>
      </div>
      <div id="auth-status" class="small">Not signed in</div>
    </div>
    <div class="auth-wrap" style="margin-top:20px;">
      <div class="auth-box">
        <h3>Sign up</h3>
        <label>Email</label><input id="su-email" type="email" placeholder="you@example.com">
        <label>Password</label>
        <div style="position:relative;"><input id="su-pass" type="password" placeholder="Enter password"><button type="button" class="password-toggle" onclick="togglePassword('su-pass')">üëÅÔ∏è</button></div>
        <button id="btn-signup" class="btn" style="width:100%; margin-top:12px;">Create Account</button>
      </div>
      <div class="auth-box">
        <h3>Sign in</h3>
        <label>Email</label><input id="si-email" type="email" placeholder="you@example.com">
        <label>Password</label>
        <div style="position:relative;"><input id="si-pass" type="password" placeholder="Password"><button type="button" class="password-toggle" onclick="togglePassword('si-pass')">üëÅÔ∏è</button></div>
        <label style="margin-top:8px;"><input type="checkbox" id="remember-me"> Remember Me</label>
        <button id="btn-signin" class="btn" style="width:100%; margin-top:12px;">Sign In</button>
        <button id="btn-google" class="btn secondary" style="width:100%; margin-top:10px;">Sign in with Google</button>
        <button id="reset-pass" class="btn secondary" style="width:100%; margin-top:10px;">Reset Password</button>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="app" class="card" style="display:none;">
    <h2>Dashboard</h2>
    <div class="profile-container">
      <img id="profile-pic" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Profile Avatar" loading="lazy">
      <div style="flex:1;">
        <label>Display Name</label>
        <input id="update-name" type="text" placeholder="Your Name">
        <button id="update-profile" class="btn" style="margin-top:8px;">Update Profile</button>
        <p class="small">Email: <span id="profile-email"></span></p>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="card" style="margin-top:20px;">
      <h3>üìù Recent Activity</h3>
      <div id="activity-feed" class="activity-feed"><div class="activity-item skeleton">Loading activities...</div></div>
    </div>

    <!-- Chat -->
    <div class="card chat-card">
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
        <h3>üí¨ Chat</h3>
        <div>
          <div id="online-count" class="small">0 online</div>
          <div id="online-users" class="small" title="Click a user to reply" style="max-width:320px; overflow:auto; padding-top:6px;"></div>
        </div>
      </div>

      <div id="messages" class="messages">
        <div class="skeleton">Loading messages...</div>
      </div>

      <div id="typing-indicator">&nbsp;</div>

      <div class="chat-controls" style="position:relative;">
        <input id="chat-input" class="chat-input" placeholder="Type a message...">
        <button id="emoji-btn" class="btn secondary">üòä</button>
        <button id="upload-btn" class="btn secondary" title="Send Image">üì∑</button>
        <input id="image-upload" type="file" accept="image/*" style="display:none;">
        <button id="send-msg" class="btn">Send</button>
      </div>

      <div id="suggestions" class="small" style="margin-top:8px; color:var(--primary);"></div>
    </div>

    <div class="footer-row">
      <p style="margin:0;">üéâ You are signed in successfully!</p>
      <p class="small">Version: v1.0.5</p>
    </div>
  </div>

  <footer>¬© 2025 Smart Camtin ‚Äî Bommmack</footer>
</main>

<!-- emoji-picker element -->
<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.21.0/index.min.js"></script>

<script type="module">
/* ===========================
   Firebase & app initialization
   =========================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, sendPasswordResetEmail, updateProfile } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc, setDoc, enableIndexedDbPersistence, getDocs, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getDatabase, ref as rdbRef, set as rdbSet, onDisconnect, onValue as rdbOnValue, serverTimestamp as rdbServerTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

const firebaseConfig = {
  apiKey:"AIzaSyDwT1JTnw6rqyTaO1sbZXD624_HblKMPZM",
  authDomain:"smartcamtin-a7e07.firebaseapp.com",
  projectId:"smartcamtin-a7e07",
  storageBucket: "smartcamtin-a7e07.appspot.com",
  appId:"1:397311969979:web:d08a7a063ba1683e16f79e",
  databaseURL: "https://smartcamtin-a7e07-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const rdb = getDatabase(app);
const storage = getStorage(app);

/* enable offline persistence for Firestore */
enableIndexedDbPersistence(db).catch(err => {
  console.warn("Persistence error:", err.code || err);
});

/* ===========================
   DOM helpers & elements
   =========================== */
const $ = id => document.getElementById(id);
const authCard = $('auth-card'), appCard = $('app'), authStatus = $('auth-status');
const signoutBtn = $('signout'), userArea = $('user-area'), authButtons = $('auth-buttons'), openAuthBtn = $('open-auth');
const userNameEl = $('user-name'), profileEmail = $('profile-email'), profilePic = $('profile-pic');
const suEmail = $('su-email'), suPass = $('su-pass'), siEmail = $('si-email'), siPass = $('si-pass');
const btnSignup = $('btn-signup'), btnSignin = $('btn-signin'), btnGoogle = $('btn-google');
const modeToggle = $('mode-toggle'), loader = $('loader'), toast = $('toast');
const rememberMe = $('remember-me'), resetPassBtn = $('reset-pass');
const updateName = $('update-name'), updateProfileBtn = $('update-profile');
const activityFeed = $('activity-feed');
const messagesEl = $('messages'), chatInput = $('chat-input'), sendMsgBtn = $('send-msg'), emojiBtn = $('emoji-btn'), typingIndicator = $('typing-indicator');
const uploadBtn = $('upload-btn'), imageUpload = $('image-upload'), suggestionsEl = $('suggestions'), onlineCountEl = $('online-count'), onlineUsersEl = $('online-users');

// Default profile avatar
const DEFAULT_AVATAR = 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';

function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 2500); }
function togglePassword(id){ const input=$(id); input.type = input.type==='password' ? 'text' : 'password'; }
window.addEventListener('load', ()=>setTimeout(()=>loader.style.display='none',700));

/* ===========================
   Theme (system auto + toggle)
   =========================== */
const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
if(!localStorage.getItem('theme') && prefersLight) { document.body.classList.add('light'); modeToggle.textContent = 'üåû'; }
if(localStorage.getItem('theme')==='light'){ document.body.classList.add('light'); modeToggle.textContent='üåû'; }
modeToggle.onclick = () => {
  document.body.classList.toggle('light');
  const isLight = document.body.classList.contains('light');
  modeToggle.textContent = isLight ? 'üåû' : 'üåô';
  localStorage.setItem('theme', isLight ? 'light' : 'dark');
};

/* ===========================
   Permission: Desktop notifications
   =========================== */
if ("Notification" in window && Notification.permission !== "granted") {
  Notification.requestPermission().catch(()=>{/* ignore */});
}
function showDesktopNotification(title, body){
  if(!("Notification" in window)) return;
  if(Notification.permission === "granted"){
    try { new Notification(title, { body, icon: profilePic.src }); } catch(e){ console.warn("Notification error", e); }
  }
}

/* ===========================
   Presence ‚Äî Realtime DB (online/offline) + clickable list
   =========================== */
let presenceRef = null;
function setPresenceForUser(user){
  try {
    if(!user) return;
    presenceRef = rdbRef(rdb, `status/${user.uid}`);
    const onlinePayload = { state: 'online', name: user.displayName || user.email, last_changed: rdbServerTimestamp() };
    const offlinePayload = { state: 'offline', name: user.displayName || user.email, last_changed: rdbServerTimestamp() };
    onDisconnect(presenceRef).set(offlinePayload).then(() => rdbSet(presenceRef, onlinePayload));

    // listen for online users and show names (clickable)
    const statusColRef = rdbRef(rdb, 'status');
    rdbOnValue(statusColRef, snap => {
      const data = snap.val() || {};
      const users = [];
      for(const [uid, val] of Object.entries(data)){
        if(!val) continue;
        if(val.state === 'online') users.push({ uid, name: val.name || 'Unknown' });
      }

      // update count
      onlineCountEl.textContent = `${users.length} online`;

      // update clickable list
      onlineUsersEl.innerHTML = '';
      if(users.length === 0){
        onlineUsersEl.textContent = 'No one is online';
      } else {
        users.forEach(u => {
          // don't show myself in the list
          if(auth.currentUser && u.uid === auth.currentUser.uid) return;
          const el = document.createElement('span');
          el.className = 'online-user';
          el.title = `Click to reply to ${u.name}`;
          el.textContent = u.name;
          el.dataset.uid = u.uid;
          el.dataset.name = u.name;
          el.addEventListener('click', () => {
            // prefill chat with mention; you can change this to open private chat flow
            chatInput.value = `@${u.name} `;
            chatInput.focus();
            showToast(`Replying to ${u.name}`);
          });
          onlineUsersEl.appendChild(el);
        });
        // if all users were filtered (only me online), show message
        if(onlineUsersEl.children.length === 0) onlineUsersEl.textContent = 'No one else online';
      }
    });
  } catch(e) { console.warn("Presence error", e); }
}

/* ===========================
   Activity logging helper
   =========================== */
function notifyAuth(t){ authStatus.textContent = t; }
async function logActivity(action){
  const user = auth.currentUser;
  if(!user) return;
  try{
    await addDoc(collection(db,"activity"),{ uid:user.uid, action, email:user.email, timestamp: serverTimestamp() });
  }catch(e){ console.error("Activity log error:", e); }
}

/* ===========================
   Load activity feed
   =========================== */
function loadActivity(uid){
  const q = query(collection(db,"activity"), orderBy("timestamp","desc"), limit(10));
  onSnapshot(q, snapshot => {
    activityFeed.innerHTML = "";
    snapshot.forEach(d => {
      const data = d.data();
      const item = document.createElement("div");
      item.className = "activity-item";
      const time = data.timestamp ? (data.timestamp.toDate ? new Date(data.timestamp.toDate()).toLocaleTimeString() : new Date().toLocaleTimeString()) : '';
      item.textContent = `[${time}] ${data.action}`;
      activityFeed.appendChild(item);
    });
  });
}

/* ===========================
   Smart reply suggestions (local)
   =========================== */
const smartReplies = ["Nice!", "On my way üöÄ", "Got it üëç", "Haha üòÇ", "Love it üî•", "Sure thing", "Working on it"];
let suggestionTimeout;
chatInput.addEventListener('input', () => {
  clearTimeout(suggestionTimeout);
  const val = chatInput.value.trim();
  if(val.length > 2){
    suggestionTimeout = setTimeout(() => {
      const s = smartReplies[Math.floor(Math.random()*smartReplies.length)];
      suggestionsEl.textContent = `Suggested: ${s} ‚Äî click to use`;
      suggestionsEl.style.cursor = 'pointer';
    }, 450);
  } else {
    suggestionsEl.textContent = '';
    suggestionsEl.style.cursor = 'default';
  }
});
suggestionsEl.addEventListener('click', () => {
  if(suggestionsEl.textContent) {
    const pick = suggestionsEl.textContent.replace('Suggested: ', '').split(' ‚Äî ')[0];
    chatInput.value += (chatInput.value ? ' ' : '') + pick;
    suggestionsEl.textContent = '';
  }
});

/* ===========================
   Messages: load, seen, notifications, edit/delete
   =========================== */
async function renderMessage(change){
  const data = change.doc.data();
  const id = change.doc.id;
  const isOwn = auth.currentUser && data.uid === auth.currentUser.uid;
  const existing = document.querySelector(`.message[data-id="${id}"]`);
  const avatar = data.avatarURL || DEFAULT_AVATAR;
  const timeStr = data.timestamp && data.timestamp.toDate ? new Date(data.timestamp.toDate()).toLocaleTimeString() : '';
  const container = existing || document.createElement('div');
  container.className = 'message' + (isOwn ? ' own' : '');
  container.dataset.id = id;

  const editedTag = data.edited ? '<span class="message-edited-tag">(edited)</span>' : '';

  container.innerHTML = `
    <img src="${avatar}" alt="avatar">
    <div style="display:flex;flex-direction:column;">
      <div class="meta">
        <strong>${data.name || 'Unknown'}</strong> ¬∑ <span style="opacity:0.6">${timeStr}</span> ${data.seen ? ' ¬∑ ‚úî' : ''}
        ${isOwn ? '<div class="message-actions"><button class="message-action-btn" data-action="edit">Edit</button><button class="message-action-btn" data-action="delete">Delete</button></div>' : ''}
      </div>
      <div class="content">${data.message || ''} ${editedTag}</div>
    </div>
  `;

  if(!existing) {
    messagesEl.appendChild(container);
  }

  // Attach action handlers for own messages
  if(isOwn) {
    const editBtn = container.querySelector('button[data-action="edit"]');
    const deleteBtn = container.querySelector('button[data-action="delete"]');
    if(editBtn) {
      editBtn.onclick = async () => {
        const currentText = data.isImage ? '' : (data.plainText || data.message || '');
        const newText = prompt('Edit your message:', currentText);
        if(newText === null) return; // cancel
        const trimmed = newText.trim();
        if(!trimmed){
          showToast('‚ö†Ô∏è Message cannot be empty');
          return;
        }
        try{
          await updateDoc(doc(db,'messages',id),{
            message: trimmed,
            plainText: trimmed,
            edited: true
          });
          await logActivity('Edited a message');
          showToast('‚úÖ Message updated');
        }catch(e){
          console.error(e);
          showToast('‚ö†Ô∏è Unable to edit message');
        }
      };
    }
    if(deleteBtn) {
      deleteBtn.onclick = async () => {
        if(!confirm('Delete this message for everyone?')) return;
        try{
          await updateDoc(doc(db,'messages',id),{
            message: '<span style="opacity:0.6;font-style:italic;">This message was deleted</span>',
            deleted: true
          });
          await logActivity('Deleted a message');
          showToast('üóë Message deleted');
        }catch(e){
          console.error(e);
          showToast('‚ö†Ô∏è Unable to delete message');
        }
      };
    }
  }
}

async function loadMessages(){
  const q = query(collection(db,"messages"), orderBy("timestamp","asc"), limit(200));
  onSnapshot(q, snapshot => {
    messagesEl.innerHTML = "";
    snapshot.docChanges().forEach(async change => {
      if(change.type === 'added' || change.type === 'modified'){
        await renderMessage(change);

        const data = change.doc.data();
        const id = change.doc.id;

        // Desktop notif & toast for messages from others
        if(auth.currentUser && data.uid !== auth.currentUser.uid && change.type === 'added'){
          showToast(`üì® New message from ${data.name}`);
          const body = (data.plainText || data.message || 'Sent an image').replace(/<[^>]+>/g,'');
          showDesktopNotification(`${data.name}`, `${body.slice(0,120)}`);
        }

        // mark as seen if it's not from me
        if(auth.currentUser && data.uid !== auth.currentUser.uid && !data.seen){
          setTimeout(async ()=> { // small delay to ensure UI rendered
            try { await setDoc(doc(db, "messages", id), { seen: true }, { merge: true }); } catch(e){ console.warn("Mark seen error", e); }
          }, 600);
        }
      }
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });
}

/* ===========================
   Send message (text)
   =========================== */
sendMsgBtn.onclick = async () => {
  const msg = chatInput.value.trim();
  if(!msg){ showToast("‚ö†Ô∏è Enter a message"); return;}
  try{
    const user = auth.currentUser;
    if(!user) { showToast("‚ö†Ô∏è You must be signed in"); return; }
    await addDoc(collection(db,"messages"),{
      uid: user.uid,
      name: user.displayName || user.email,
      avatarURL: user.photoURL || DEFAULT_AVATAR,
      message: msg,
      plainText: msg,
      timestamp: serverTimestamp(),
      seen: false,
      edited: false
    });
    chatInput.value = "";
    suggestionsEl.textContent = '';
  }catch(e){ showToast("‚ö†Ô∏è "+(e.message || e)); console.error(e); }
};

/* ===========================
   Image upload & send
   =========================== */
uploadBtn.onclick = () => imageUpload.click();
imageUpload.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if(!file) return;
  const user = auth.currentUser;
  if(!user){ showToast("‚ö†Ô∏è Sign in to send images"); return; }
  const path = `chat_images/${user.uid}_${Date.now()}_${file.name.replace(/\s+/g,'_')}`;
  const storageRef = sRef(storage, path);
  showToast("Uploading image...");
  try{
    const snap = await uploadBytes(storageRef, file);
    const url = await getDownloadURL(snap.ref);
    await addDoc(collection(db,"messages"), {
      uid: user.uid,
      name: user.displayName || user.email,
      avatarURL: user.photoURL || DEFAULT_AVATAR,
      message: `<img src="${url}" style="max-width:300px; border-radius:8px;">`,
      timestamp: serverTimestamp(),
      seen: false,
      isImage: true
    });
    showToast("‚úÖ Image sent");
  }catch(err){ showToast("‚ö†Ô∏è Upload failed"); console.error(err); }
});

/* ===========================
   Typing indicator (Firestore 'typing' collection)
   =========================== */
chatInput.addEventListener('input', async () => {
  const user = auth.currentUser;
  if(!user) return;
  const typingRef = doc(db, 'typing', user.uid);
  try{
    await setDoc(typingRef, { name: user.displayName || user.email, isTyping: true, timestamp: serverTimestamp() });
  }catch(e){ console.warn("Typing set error", e); }
  clearTimeout(window.typingTimeout);
  window.typingTimeout = setTimeout(async ()=>{
    try{ await setDoc(typingRef, { name: user.displayName || user.email, isTyping: false, timestamp: serverTimestamp() }); } catch(e){/*ignore*/ }
  }, 1600);
});

const typingCol = collection(db, 'typing');
onSnapshot(typingCol, snap => {
  let typingUsers = [];
  snap.forEach(d => {
    const data = d.data();
    if(!auth.currentUser) return;
    if(data.isTyping && d.id !== auth.currentUser.uid) typingUsers.push(data.name);
  });
  typingIndicator.textContent = typingUsers.length ? `${typingUsers.join(', ')} is typing...` : '';
});

/* ===========================
   Auth events
   =========================== */
btnSignup.onclick = async () => {
  try{
    await createUserWithEmailAndPassword(auth, suEmail.value, suPass.value);
    showToast("‚úÖ Account created!");
    logActivity("Signed up with email");
  }catch(e){ showToast("‚ö†Ô∏è "+(e.message || e)); console.error(e); }
};

btnSignin.onclick = async () => {
  try{
    await signInWithEmailAndPassword(auth, siEmail.value, siPass.value);
    showToast("‚úÖ Signed in!");
    logActivity("Signed in with email");
    if(rememberMe.checked) localStorage.setItem('rememberedEmail', siEmail.value); else localStorage.removeItem('rememberedEmail');
  }catch(e){ showToast("‚ö†Ô∏è "+(e.message || e)); console.error(e); }
};

btnGoogle.onclick = async () => {
  try{
    await signInWithPopup(auth, new GoogleAuthProvider());
    showToast("‚úÖ Google sign-in success!");
    logActivity("Signed in with Google");
  }catch(e){ showToast("‚ö†Ô∏è "+(e.message || e)); console.error(e); }
};

/* ===========================
   Sign Out Handler - Fixed & Reliable
   =========================== */
async function handleSignOut(e) {
  if(e) {
    e.preventDefault();
    e.stopPropagation();
  }
  
  console.log("Sign out initiated");
  showToast("Signing out...");
  
  // Immediately reset UI first for instant feedback
  resetToSignInPage();
  
  try {
    // Set presence to offline before signing out
    if(presenceRef) {
      try {
        await rdbSet(presenceRef, { state: 'offline', last_changed: rdbServerTimestamp() });
      } catch(presErr) {
        console.warn("Presence update error:", presErr);
      }
    }
    
    // Sign out from Firebase Auth
    await signOut(auth);
    console.log("Firebase signOut completed successfully");
    
  } catch(err) {
    console.error("Sign out error:", err);
  }
}

function resetToSignInPage() {
  console.log("Resetting UI to sign in page...");
  
  // Show auth card (sign in/sign up)
  if(authCard) authCard.style.display = 'block'; 
  if(appCard) appCard.style.display = 'none';
  
  // Update nav buttons
  if(userArea) userArea.style.display = 'none'; 
  if(authButtons) authButtons.style.display = 'flex';
  
  // Update status
  notifyAuth("Not signed in");
  
  // Reset profile picture to default
  if(profilePic) profilePic.src = DEFAULT_AVATAR;
  
  // Clear user-specific data
  if(messagesEl) messagesEl.innerHTML = '<div class="skeleton">Loading messages...</div>';
  if(activityFeed) activityFeed.innerHTML = '<div class="activity-item skeleton">Loading activities...</div>';
  if(onlineUsersEl) onlineUsersEl.innerHTML = '';
  if(onlineCountEl) onlineCountEl.textContent = '0 online';
  if(userNameEl) userNameEl.textContent = 'Hi, user';
  if(profileEmail) profileEmail.textContent = '';
  if(updateName) updateName.value = '';
  
  // Scroll to top to show sign in form
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  showToast("‚úÖ You have been signed out!");
  console.log("UI reset completed");
}

// Attach sign out event - use only addEventListener for reliability
if(signoutBtn) {
  signoutBtn.addEventListener('click', handleSignOut);
  console.log("Sign out button event attached");
}

openAuthBtn.onclick = () => authCard.style.display = authCard.style.display === 'none' ? 'block' : 'none';

resetPassBtn.onclick = async () => {
  if(!siEmail.value){ showToast("‚ö†Ô∏è Enter your email"); return; }
  try{ await sendPasswordResetEmail(auth, siEmail.value); showToast("‚úÖ Reset email sent!"); logActivity("Requested password reset"); } catch(e){ showToast("‚ö†Ô∏è "+(e.message||e)); }
};

updateProfileBtn.onclick = async () => {
  try{
    await updateProfile(auth.currentUser, { displayName: updateName.value });
    showToast("‚úÖ Profile updated!");
    logActivity("Updated profile");
    // refresh UI
    onAuthStateChanged(auth, auth.currentUser);
  }catch(e){ showToast("‚ö†Ô∏è "+(e.message || e)); }
};

if(localStorage.getItem('rememberedEmail')) siEmail.value = localStorage.getItem('rememberedEmail');

/* ===========================
   Auth state observer
   =========================== */
onAuthStateChanged(auth, user => {
  if(user){
    notifyAuth("Signed in");
    authCard.style.display = 'none'; appCard.style.display = 'block';
    userArea.style.display = 'flex'; authButtons.style.display = 'none';
    userNameEl.textContent = user.displayName || user.email;
    profileEmail.textContent = user.email;
    // Use default avatar if no photoURL
    profilePic.src = user.photoURL || DEFAULT_AVATAR;
    updateName.value = user.displayName || "";
    setPresenceForUser(user);
    loadActivity(user.uid);
    loadMessages();
  } else {
    notifyAuth("Not signed in");
    authCard.style.display = 'block'; appCard.style.display = 'none';
    userArea.style.display = 'none'; authButtons.style.display = 'flex';
    // Reset profile pic to default when signed out
    profilePic.src = DEFAULT_AVATAR;
  }
});

/* ===========================
   Emoji picker (in-place)
   =========================== */
let picker;
emojiBtn.addEventListener('click', () => {
  if(!picker){
    picker = document.createElement('emoji-picker');
    picker.style.position = 'absolute';
    picker.style.bottom = '60px';
    picker.style.right = '12px';
    picker.style.zIndex = 9999;
    document.body.appendChild(picker);
    picker.addEventListener('emoji-click', event => {
      chatInput.value += event.detail.unicode;
      picker.style.display = 'none';
      chatInput.focus();
    });
  }
  picker.style.display = picker.style.display === 'none' || !picker.style.display ? 'block' : 'none';
});

/* ===========================
   Focus shortcuts
   =========================== */
chatInput.addEventListener('keydown', (e) => {
  if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMsgBtn.click(); }
});

/* ===========================
   Initial UI tweaks
   =========================== */
setTimeout(()=>{ loader.style.display='none'; }, 700);

/* ===========================
   End of module
   =========================== */
   
/* =========================
   üéÑ Christmas Snow Effect
   ========================= */

const canvas = document.getElementById("snow-canvas");
const ctx = canvas.getContext("2d");

let w, h;
function resize() {
  w = canvas.width = window.innerWidth;
  h = canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

const snowflakes = Array.from({ length: 120 }, () => ({
  x: Math.random() * w,
  y: Math.random() * h,
  r: Math.random() * 3 + 1,
  d: Math.random() + 1
}));

function snow() {
  ctx.clearRect(0, 0, w, h);
  ctx.fillStyle = "rgba(255,255,255,0.85)";
  ctx.beginPath();
  snowflakes.forEach(f => {
    ctx.moveTo(f.x, f.y);
    ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
  });
  ctx.fill();

  snowflakes.forEach(f => {
    f.y += Math.pow(f.d, 2);
    if (f.y > h) {
      f.y = 0;
      f.x = Math.random() * w;
    }
  });

  requestAnimationFrame(snow);
}
snow();

/* =========================
   üéÖ Christmas Mode Toggle
   ========================= */
const santa = document.getElementById("santa");

santa.addEventListener("click", () => {
  document.body.classList.toggle("christmas");

  document.querySelectorAll(".card").forEach(card => {
    card.classList.toggle("christmas-glow");
  });

  santa.textContent =
    document.body.classList.contains("christmas") ? "üéÅ" : "üéÖ";
});

</script>
</body>
</html>